<div class="comment-toggle-buttons">
    <button id="show-giscus" class="active" onclick="showGiscus()">Github Discussions</button>
    <button id="show-telegram" onclick="showTelegram()">Telegram Comments</button>
</div>

<div id="github-discussions" class="comment-box"></div>
<div id="telegram-comments" class="comment-box"></div>

<style>
    .comment-toggle-buttons {
        display: flex;
        justify-content: center;
        margin-top: 50px;
        margin-bottom: 10px;
        gap: 10px;
    }

    #telegram-comments {
        border-radius: var(--radius);
        min-height: 378.2px;
        display: none;
    }

    .comment-toggle-buttons button {
        display: block;
        padding: 0 14px;
        color: var(--primary);
        font-size: 14px;
        line-height: 34px;
        background: var(--code-bg);
        border-radius: var(--radius);
        border: 1px solid var(--border);
    }

    .comment-toggle-buttons button:hover {
        background: var(--border);
    }

    .comment-toggle-buttons button.active {
        pointer-events: none;
        background-color: transparent;
    }
</style>

<script>
    let telegramLoaded = false;

    function showGiscus() {
        document.getElementById('show-giscus').classList.add('active');
        document.getElementById('show-telegram').classList.remove('active');
        document.getElementById('github-discussions').style.display = 'block';
        document.getElementById('telegram-comments').style.display = 'none';
        setGiscusTheme();
    }

    function showTelegram() {
        document.getElementById('show-giscus').classList.remove('active');
        document.getElementById('show-telegram').classList.add('active');
        document.getElementById('github-discussions').style.display = 'none';
        document.getElementById('telegram-comments').style.display = 'block';
        if (!telegramLoaded) {
            loadTelegramWidget();
            telegramLoaded = true;
        }
    }

    const getStoredTheme = () => localStorage.getItem("pref-theme") === "dark" ? "dark" : "light";

    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
            }
        };
        sendMessage({ setConfig: { theme: getStoredTheme() === 'dark' ? 'noborder_dark' : 'noborder_light' } });
    };

    const loadTelegramWidget = () => {
        const telegramDiv = document.getElementById('telegram-comments');
        telegramDiv.innerHTML = "";
        const telegramScript = document.createElement("script");
        telegramScript.src = "https://comments.app/js/widget.js?3";
        telegramScript.defer = true;
        telegramScript.setAttribute("data-comments-app-website", "i7gjmkOw");
        telegramScript.setAttribute("data-limit", "100");
        telegramScript.setAttribute("data-height", "371");
        telegramScript.setAttribute("data-dislikes", "1");
        telegramScript.setAttribute("data-colorful", "1");
        telegramScript.setAttribute("data-dark", getStoredTheme() === "dark" ? "1" : "0");
        telegramDiv.appendChild(telegramScript);
    };

    const setTelegramTheme = () => {
        loadTelegramWidget();
    };

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "Xeonzilla/Xeonzilla.github.io",
            "data-repo-id": "R_kgDOL6BvNQ",
            "data-category": "Announcements",
            "data-category-id": "DIC_kwDOL6BvNc4Cfb8m",
            "data-mapping": "pathname",
            "data-strict": "1",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "top",
            "data-theme": getStoredTheme() === 'dark' ? 'noborder_dark' : 'noborder_light',
            "data-lang": "zh-CN",
            "crossorigin": "anonymous",
        };

        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
            ([key, value]) => giscusScript.setAttribute(key, value));
        giscusScript.defer = true;
        document.querySelector("#github-discussions").appendChild(giscusScript);

        if (document.getElementById('telegram-comments').style.display === 'block') {
            loadTelegramWidget();
            telegramLoaded = true;
        }

        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", () => {
                setGiscusTheme();
                setTelegramTheme();
            });
        }
    });
</script>