<div id="comment-toggle-buttons" class="flex flex-row justify-center">
    <button id="show-giscus" aria-selected="true"
        class="text-neutral-700 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 active"
        onclick="showGiscus()">Github Discussions</button>
    <button id="show-telegram" aria-selected="false"
        class="text-neutral-700 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400"
        onclick="showTelegram()">Telegram Comments</button>
</div>

<div id="github-discussions" class="flex"></div>
<div id="telegram-comments" class="flex"></div>

<style>
    #comment-toggle-buttons {
        gap: 40px;
        margin: 40px 0 20px;
    }

    #github-discussions {
        min-height: 370.6px;
    }

    #telegram-comments {
        min-height: 370.6px;
        display: none;
    }
</style>

<script>
    let telegramLoaded = false;

    function showGiscus() {
        document.getElementById('show-giscus').classList.add('active');
        document.getElementById('show-giscus').setAttribute('aria-selected', 'true');
        document.getElementById('github-discussions').style.display = 'block';
        document.getElementById('show-telegram').classList.remove('active');
        document.getElementById('show-telegram').setAttribute('aria-selected', 'false');
        document.getElementById('telegram-comments').style.display = 'none';
        setGiscusTheme();
    }

    function showTelegram() {
        document.getElementById('show-telegram').classList.add('active');
        document.getElementById('show-telegram').setAttribute('aria-selected', 'true');
        document.getElementById('telegram-comments').style.display = 'block';
        document.getElementById('show-giscus').classList.remove('active');
        document.getElementById('show-giscus').setAttribute('aria-selected', 'false');
        document.getElementById('github-discussions').style.display = 'none';
        if (!telegramLoaded) {
            loadTelegramWidget();
            telegramLoaded = true;
        }
    }

    const isDarkMode = () => document.documentElement.classList.contains('dark');

    const setGiscusTheme = () => {
        const sendMessage = (message) => {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
            }
        };
        sendMessage({ setConfig: { theme: isDarkMode() ? 'noborder_dark' : 'noborder_light' } });
    };

    const loadTelegramWidget = () => {
        const telegramDiv = document.getElementById('telegram-comments');
        telegramDiv.innerHTML = "";
        const telegramScript = document.createElement("script");
        telegramScript.src = "https://comments.app/js/widget.js?3";
        telegramScript.defer = true;
        telegramScript.setAttribute("data-comments-app-website", "i7gjmkOw");
        telegramScript.setAttribute("data-limit", "100");
        telegramScript.setAttribute("data-height", "370.6");
        telegramScript.setAttribute("data-dislikes", "1");
        telegramScript.setAttribute("data-colorful", "1");
        telegramScript.setAttribute("data-dark", isDarkMode() ? "1" : "0");
        telegramDiv.appendChild(telegramScript);
    };

    const setTelegramTheme = () => {
        if (document.getElementById('telegram-comments').style.display === 'block') {
            loadTelegramWidget();
        }
    };

    const observer = new MutationObserver((mutationsList) => {
        mutationsList.forEach(mutation => {
            if (mutation.attributeName === 'class') {
                setGiscusTheme();
                setTelegramTheme();
            }
        });
    });

    observer.observe(document.documentElement, { attributes: true });

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "Xeonzilla/Xeonzilla.github.io",
            "data-repo-id": "R_kgDOL6BvNQ",
            "data-category": "Announcements",
            "data-category-id": "DIC_kwDOL6BvNc4Cfb8m",
            "data-mapping": "pathname",
            "data-strict": "1",
            "data-reactions-actived": "1",
            "data-emit-metadata": "0",
            "data-input-position": "top",
            "data-theme": isDarkMode() ? 'noborder_dark' : 'noborder_light',
            "data-lang": "zh-CN",
            "crossorigin": "anonymous",
        };

        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
            ([key, value]) => giscusScript.setAttribute(key, value));
        giscusScript.defer = true;
        document.querySelector("#github-discussions").appendChild(giscusScript);

        if (document.getElementById('telegram-comments').style.display === 'block') {
            loadTelegramWidget();
            telegramLoaded = true;
        }
    });
</script>